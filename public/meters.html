<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–°—á—ë—Ç—á–∏–∫–∏ - –£–ö ¬´–ó–µ–ª—ë–Ω–∞—è –¥–æ–ª–∏–Ω–∞¬ª v6.5.0</title>
    
    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#2E7D32">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <link rel="icon" type="image/png" sizes="32x32" href="./icon-48x48.png">
    <link rel="icon" type="image/png" sizes="192x192" href="./icon-192x192.png">
    <link rel="apple-touch-icon" sizes="180x180" href="./icon-180x180.png">
    
    <!-- –ù–∞–≤–∏–≥–∞—Ü–∏—è -->
    <link rel="stylesheet" href="css/navigation.css">
    <script src="js/navigation.js" defer></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%);
            min-height: 100vh;
            padding: 20px 20px 100px 20px;
        }
        
        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }
        
        .header h1 {
            font-size: 28px;
            margin-bottom: 5px;
        }
        
        .back-button {
            position: fixed;
            top: 20px;
            left: 20px;
            background: white;
            border: none;
            border-radius: 50%;
            width: 48px;
            height: 48px;
            font-size: 24px;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            z-index: 100;
        }
        
        .card {
            background: white;
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 20px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        .next-deadline {
            background: #fff3cd;
            color: #856404;
            padding: 16px;
            border-radius: 12px;
            text-align: center;
            margin-bottom: 24px;
            font-size: 16px;
        }
        
        .meter-card {
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .meter-header {
            display: flex;
            align-items: center;
            margin-bottom: 16px;
        }
        
        .meter-icon {
            font-size: 32px;
            margin-right: 12px;
        }
        
        .meter-title {
            font-size: 18px;
            font-weight: 600;
            color: #333;
        }
        
        .previous-reading {
            font-size: 14px;
            color: #666;
            margin-bottom: 12px;
        }
        
        .meter-input {
            width: 100%;
            padding: 16px;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            font-size: 20px;
            margin-bottom: 12px;
            transition: border-color 0.3s;
        }
        
        .meter-input:focus {
            outline: none;
            border-color: #2E7D32;
        }
        
        .btn-photo {
            width: 100%;
            padding: 12px;
            background: #3498db;
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            cursor: pointer;
        }
        
        .btn-submit-large {
            width: 100%;
            padding: 18px;
            background: #2E7D32;
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 20px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 20px;
        }
        
        .history-chart {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            min-height: 200px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #666;
        }
        
        .history-table {
            overflow-x: auto;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
        }
        
        th {
            background: #f8f9fa;
            font-weight: 600;
            color: #333;
        }
        
        .error-message {
            background: #ffebee;
            color: #c62828;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 16px;
            display: none;
        }
        
        .error-message.show {
            display: block;
        }
        
        .success-message {
            background: #e8f5e9;
            color: #2e7d32;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 16px;
            display: none;
        }
        
        .success-message.show {
            display: block;
        }
    </style>
    
    <!-- –ì–ª–æ–±–∞–ª—å–Ω–∞—è –∑–∞—â–∏—Ç–∞ –æ—Ç –æ—à–∏–±–æ–∫ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–π -->
    <script>
        // ====================================
        // üõ°Ô∏è –ì–õ–û–ë–ê–õ–¨–ù–ê–Ø –ó–ê–©–ò–¢–ê –û–¢ –û–®–ò–ë–û–ö –†–ê–°–®–ò–†–ï–ù–ò–ô v6.5.0
        // ====================================
        
        (function() {
            'use strict';
            
            // –°—á—ë—Ç—á–∏–∫ –ø–æ–¥–∞–≤–ª–µ–Ω–Ω—ã—Ö –æ—à–∏–±–æ–∫ (–¥–ª—è –æ—Ç–ª–∞–¥–∫–∏)
            let suppressedErrors = 0;
            
            // –°–ø–∏—Å–æ–∫ –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤ –æ—à–∏–±–æ–∫ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–π
            const extensionErrorPatterns = [
                'message channel closed',
                'Extension context invalidated',
                'chrome-extension://',
                'moz-extension://',
                'content_script.js',
                'Cannot read properties of undefined',
                'reading \'control\'',
                'reading \'runtime\'',
                'sending a message',
                'Receiving end does not exist',
                'Could not establish connection'
            ];
            
            // –ü—Ä–æ–≤–µ—Ä–∫–∞, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –æ—à–∏–±–∫–∞ –æ—Ç —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è
            function isExtensionError(errorMessage, errorStack) {
                if (!errorMessage && !errorStack) return false;
                
                const fullText = (errorMessage || '') + ' ' + (errorStack || '');
                
                return extensionErrorPatterns.some(pattern => 
                    fullText.toLowerCase().includes(pattern.toLowerCase())
                );
            }
            
            // –ì–ª–æ–±–∞–ª—å–Ω—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—à–∏–±–æ–∫
            const originalErrorHandler = window.onerror;
            window.onerror = function(message, source, lineno, colno, error) {
                if (isExtensionError(message, error ? error.stack : '')) {
                    suppressedErrors++;
                    console.warn(
                        `[Global] üõ°Ô∏è –ü–æ–¥–∞–≤–ª–µ–Ω–∞ –æ—à–∏–±–∫–∞ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è #${suppressedErrors}:`, 
                        message.substring(0, 100)
                    );
                    return true; // –ü–æ–¥–∞–≤–∏—Ç—å –æ—à–∏–±–∫—É
                }
                
                // –ü–µ—Ä–µ–¥–∞—Ç—å –¥—Ä—É–≥–∏–µ –æ—à–∏–±–∫–∏ –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–º—É –æ–±—Ä–∞–±–æ—Ç—á–∏–∫—É
                if (originalErrorHandler) {
                    return originalErrorHandler.apply(this, arguments);
                }
                return false;
            };
            
            // –ì–ª–æ–±–∞–ª—å–Ω—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ unhandled promise rejections
            window.addEventListener('unhandledrejection', function(event) {
                const reason = event.reason;
                const message = reason ? (reason.message || reason.toString()) : '';
                const stack = reason ? reason.stack : '';
                
                if (isExtensionError(message, stack)) {
                    suppressedErrors++;
                    console.warn(
                        `[Global] üõ°Ô∏è –ü–æ–¥–∞–≤–ª–µ–Ω Promise rejection #${suppressedErrors}:`, 
                        message.substring(0, 100)
                    );
                    event.preventDefault();
                }
            });
            
            // –ì–ª–æ–±–∞–ª—å–Ω—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–æ–±—ã—Ç–∏–π focus (–≥–¥–µ –≤–æ–∑–Ω–∏–∫–∞–µ—Ç –æ—à–∏–±–∫–∞ content_script)
            document.addEventListener('focusin', function(event) {
                // –û–±–µ—Ä–Ω—É—Ç—å –≤ try-catch –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è —Ä–∞—Å–ø—Ä–æ—Å—Ç—Ä–∞–Ω–µ–Ω–∏—è –æ—à–∏–±–æ–∫ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–π
                try {
                    // –ö–æ–¥ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Ñ–æ–∫—É—Å–∞ (–µ—Å–ª–∏ –Ω—É–∂–µ–Ω)
                } catch (error) {
                    if (isExtensionError(error.message, error.stack)) {
                        suppressedErrors++;
                        console.warn('[Global] üõ°Ô∏è –ü–æ–¥–∞–≤–ª–µ–Ω–∞ –æ—à–∏–±–∫–∞ focusin –æ—Ç —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è');
                    }
                }
            }, true); // true = capture phase (–¥–æ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–π)
            
            // –û—Ç—á—ë—Ç –æ –ø–æ–¥–∞–≤–ª–µ–Ω–Ω—ã—Ö –æ—à–∏–±–∫–∞—Ö (–∫–∞–∂–¥—ã–µ 10 —Å–µ–∫—É–Ω–¥)
            setInterval(function() {
                if (suppressedErrors > 0) {
                    console.log(`[Global] üìä –ü–æ–¥–∞–≤–ª–µ–Ω–æ –æ—à–∏–±–æ–∫ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–π: ${suppressedErrors}`);
                }
            }, 10000);
            
            console.log('[Global] üõ°Ô∏è –ó–∞—â–∏—Ç–∞ –æ—Ç –æ—à–∏–±–æ–∫ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–π v6.5.0 –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–∞');
            console.log('[Global] üìã –û—Ç—Å–ª–µ–∂–∏–≤–∞—é—Ç—Å—è –ø–∞—Ç—Ç–µ—Ä–Ω—ã:', extensionErrorPatterns.length);
        })();
    </script>
    
    <!-- –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∑–∞—â–∏—Ç–∞ –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö –ø–æ–ª–µ–π –≤–≤–æ–¥–∞ -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // –û—Ç–∫–ª—é—á–∏—Ç—å –∞–≤—Ç–æ–∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –Ω–∞ –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö –ø–æ–ª—è—Ö (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)
            const sensitiveFields = document.querySelectorAll('input[type="tel"], input[type="text"]');
            sensitiveFields.forEach(field => {
                // –î–æ–±–∞–≤–∏—Ç—å –∞—Ç—Ä–∏–±—É—Ç—ã –¥–ª—è –æ—Ç–∫–ª—é—á–µ–Ω–∏—è –∞–≥—Ä–µ—Å—Å–∏–≤–Ω—ã—Ö —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–π
                field.setAttribute('autocomplete', 'off');
                field.setAttribute('data-lpignore', 'true'); // LastPass
                field.setAttribute('data-form-type', 'other'); // 1Password
                field.setAttribute('data-bwignore', 'true'); // Bitwarden
            });
            
            console.log('[Fields] üîí –ó–∞—â–∏—Ç–∞ –ø–æ–ª–µ–π –≤–≤–æ–¥–∞ –ø—Ä–∏–º–µ–Ω–µ–Ω–∞ –∫', sensitiveFields.length, '—ç–ª–µ–º–µ–Ω—Ç–∞–º');
        });
    </script>
</head>
<body>
    <button class="back-button" onclick="window.location.href='index.html'">‚Üê</button>
    
    <div class="header">
        <h1>üìä –ü–æ–∫–∞–∑–∞–Ω–∏—è —Å—á—ë—Ç—á–∏–∫–æ–≤</h1>
    </div>
    
    <div class="next-deadline">
        –°–ª–µ–¥—É—é—â–∞—è –ø–µ—Ä–µ–¥–∞—á–∞ –ø–æ–∫–∞–∑–∞–Ω–∏–π: <strong>–¥–æ 30.11.2025</strong>
    </div>
    
    <div id="errorMessage" class="error-message"></div>
    <div id="successMessage" class="success-message"></div>
    
    <!-- –§–æ—Ä–º–∞ –≤–≤–æ–¥–∞ -->
    <div class="card">
        <h2 style="color: #2E7D32; margin-bottom: 20px;">–ü–µ—Ä–µ–¥–∞—Ç—å –ø–æ–∫–∞–∑–∞–Ω–∏—è</h2>
        
        <!-- –•–æ–ª–æ–¥–Ω–∞—è –≤–æ–¥–∞ -->
        <div class="meter-card">
            <div class="meter-header">
                <div class="meter-icon">üíß</div>
                <div class="meter-title">–•–æ–ª–æ–¥–Ω–∞—è –≤–æ–¥–∞ (–•–í–°)</div>
            </div>
            <div class="meter-body">
                <div class="previous-reading">
                    –ü—Ä–µ–¥—ã–¥—É—â–µ–µ: <strong>1234.56 –º¬≥</strong> (05.11.2025)
                </div>
                <input 
                    type="number" 
                    class="meter-input" 
                    id="coldWater"
                    placeholder="–í–≤–µ–¥–∏—Ç–µ –ø–æ–∫–∞–∑–∞–Ω–∏—è"
                    step="0.01"
                    min="1234.56"
                >
                <button class="btn-photo" onclick="takeMeterPhoto('coldWater')">
                    üì∑ –°—Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—Ä–æ–≤–∞—Ç—å
                </button>
            </div>
        </div>
        
        <!-- –ì–æ—Ä—è—á–∞—è –≤–æ–¥–∞ -->
        <div class="meter-card">
            <div class="meter-header">
                <div class="meter-icon">üî•</div>
                <div class="meter-title">–ì–æ—Ä—è—á–∞—è –≤–æ–¥–∞ (–ì–í–°)</div>
            </div>
            <div class="meter-body">
                <div class="previous-reading">
                    –ü—Ä–µ–¥—ã–¥—É—â–µ–µ: <strong>987.32 –º¬≥</strong> (05.11.2025)
                </div>
                <input 
                    type="number" 
                    class="meter-input" 
                    id="hotWater"
                    placeholder="–í–≤–µ–¥–∏—Ç–µ –ø–æ–∫–∞–∑–∞–Ω–∏—è"
                    step="0.01"
                    min="987.32"
                >
                <button class="btn-photo" onclick="takeMeterPhoto('hotWater')">
                    üì∑ –°—Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—Ä–æ–≤–∞—Ç—å
                </button>
            </div>
        </div>
        
        <!-- –ì–∞–∑ -->
        <div class="meter-card" style="border-left: 4px solid #ff9800;">
            <div class="meter-header">
                <div class="meter-icon">üî•</div>
                <div class="meter-title">–ì–∞–∑</div>
            </div>
            <div class="meter-body">
                <div class="previous-reading">
                    –ü—Ä–µ–¥—ã–¥—É—â–µ–µ: <strong>12345 –º¬≥</strong> (05.11.2025)
                </div>
                <input 
                    type="number" 
                    class="meter-input" 
                    id="gas"
                    placeholder="–í–≤–µ–¥–∏—Ç–µ –ø–æ–∫–∞–∑–∞–Ω–∏—è"
                    step="0.01"
                    min="12345"
                >
                <button class="btn-photo" onclick="takeMeterPhoto('gas')">
                    üì∑ –°—Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—Ä–æ–≤–∞—Ç—å
                </button>
            </div>
        </div>
        
        <!-- –≠–ª–µ–∫—Ç—Ä–∏—á–µ—Å—Ç–≤–æ -->
        <div class="meter-card">
            <div class="meter-header">
                <div class="meter-icon">‚ö°</div>
                <div class="meter-title">–≠–ª–µ–∫—Ç—Ä–æ—ç–Ω–µ—Ä–≥–∏—è</div>
            </div>
            <div class="meter-body">
                <div class="previous-reading">
                    –ü—Ä–µ–¥—ã–¥—É—â–µ–µ: <strong>45678 –∫–í—Ç‚ãÖ—á</strong> (05.11.2025)
                </div>
                <input 
                    type="number" 
                    class="meter-input" 
                    id="electricity"
                    placeholder="–í–≤–µ–¥–∏—Ç–µ –ø–æ–∫–∞–∑–∞–Ω–∏—è"
                    min="45678"
                >
                <button class="btn-photo" onclick="takeMeterPhoto('electricity')">
                    üì∑ –°—Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—Ä–æ–≤–∞—Ç—å
                </button>
            </div>
        </div>
        
        <button class="btn-submit-large" onclick="submitMeterReadings()">
            –û—Ç–ø—Ä–∞–≤–∏—Ç—å –ø–æ–∫–∞–∑–∞–Ω–∏—è
        </button>
    </div>
    
    <!-- –ò—Å—Ç–æ—Ä–∏—è –ø–æ–∫–∞–∑–∞–Ω–∏–π -->
    <div class="card">
        <h2 style="color: #2E7D32; margin-bottom: 20px;">–ò—Å—Ç–æ—Ä–∏—è –ø–æ–∫–∞–∑–∞–Ω–∏–π</h2>
        
        <div class="history-chart" id="meterChart">
            <div style="text-align: center;">
                <div style="font-size: 48px; margin-bottom: 10px;">üìà</div>
                <div>–ì—Ä–∞—Ñ–∏–∫ –ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏—è</div>
                <div style="font-size: 12px; color: #999; margin-top: 5px;">(–í production: –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –±–∏–±–ª–∏–æ—Ç–µ–∫–æ–π –≥—Ä–∞—Ñ–∏–∫–æ–≤)</div>
            </div>
        </div>
        
        <div class="history-table">
            <table id="meterHistoryTable">
                <thead>
                    <tr>
                        <th>–î–∞—Ç–∞</th>
                        <th>–•–í–° (–º¬≥)</th>
                        <th>–ì–í–° (–º¬≥)</th>
                        <th>–ì–∞–∑ (–º¬≥)</th>
                        <th>–≠–ª–µ–∫—Ç—Ä–∏—á–µ—Å—Ç–≤–æ (–∫–í—Ç‚ãÖ—á)</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- –ó–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è —á–µ—Ä–µ–∑ JS -->
                </tbody>
            </table>
        </div>
    </div>
    
    <script src="auth.js"></script>
    <script>
        // –í–ê–ñ–ù–û: –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –¢–û–õ–¨–ö–û –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ DOM
        document.addEventListener('DOMContentLoaded', () => {
            console.log('[Page] –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏...');
            
            if (!requireAuth()) {
                console.log('[Page] –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω, —Ä–µ–¥–∏—Ä–µ–∫—Ç –Ω–∞ login');
                return;
            }
            
            console.log('[Page] –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã...');
            initializePage();
        });
        
        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è –ø–æ–∫–∞–∑–∞–Ω–∏–π
        const previousReadings = {
            coldWater: 1234.56,
            hotWater: 987.32,
            gas: 12345,
            electricity: 45678
        };
        
        const meterHistory = [
            { date: '2025-10-05', coldWater: 1234.56, hotWater: 987.32, gas: 12345, electricity: 45678 },
            { date: '2025-09-05', coldWater: 1219.23, hotWater: 978.65, gas: 12320, electricity: 45433 },
            { date: '2025-08-05', coldWater: 1203.90, hotWater: 970.12, gas: 12295, electricity: 45188 },
            { date: '2025-07-05', coldWater: 1188.67, hotWater: 961.45, gas: 12270, electricity: 44943 }
        ];
        
        function initializePage() {
            const session = getSession();
            console.log('[Page] –°–µ—Å—Å–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:', session);
            
            // –ó–∞–≥—Ä—É–∑–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏ –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏
            renderHistory();
        }
        
        function showError(message) {
            const errorDiv = document.getElementById('errorMessage');
            errorDiv.textContent = message;
            errorDiv.classList.add('show');
            document.getElementById('successMessage').classList.remove('show');
        }
        
        function showSuccess(message) {
            const successDiv = document.getElementById('successMessage');
            successDiv.textContent = message;
            successDiv.classList.add('show');
            document.getElementById('errorMessage').classList.remove('show');
        }
        
        function hideMessages() {
            document.getElementById('errorMessage').classList.remove('show');
            document.getElementById('successMessage').classList.remove('show');
        }
        
        function submitMeterReadings() {
            hideMessages();
            
            const readings = {
                coldWater: parseFloat(document.getElementById('coldWater').value),
                hotWater: parseFloat(document.getElementById('hotWater').value),
                gas: parseFloat(document.getElementById('gas').value),
                electricity: parseFloat(document.getElementById('electricity').value)
            };
            
            // –í–∞–ª–∏–¥–∞—Ü–∏—è
            if (!readings.coldWater || readings.coldWater < previousReadings.coldWater) {
                showError('–ü–æ–∫–∞–∑–∞–Ω–∏—è –•–í–° –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –±–æ–ª—å—à–µ –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö (' + previousReadings.coldWater + ')');
                return;
            }
            
            if (!readings.hotWater || readings.hotWater < previousReadings.hotWater) {
                showError('–ü–æ–∫–∞–∑–∞–Ω–∏—è –ì–í–° –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –±–æ–ª—å—à–µ –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö (' + previousReadings.hotWater + ')');
                return;
            }
            
            if (!readings.gas || readings.gas < previousReadings.gas) {
                showError('–ü–æ–∫–∞–∑–∞–Ω–∏—è –≥–∞–∑–∞ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –±–æ–ª—å—à–µ –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö (' + previousReadings.gas + ' –º¬≥)');
                return;
            }
            
            if (!readings.electricity || readings.electricity < previousReadings.electricity) {
                showError('–ü–æ–∫–∞–∑–∞–Ω–∏—è —ç–ª–µ–∫—Ç—Ä–æ—ç–Ω–µ—Ä–≥–∏–∏ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –±–æ–ª—å—à–µ –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö (' + previousReadings.electricity + ')');
                return;
            }
            
            // –ü–æ–∫–∞–∑–∞—Ç—å –ª–æ–∞–¥–µ—Ä
            const loader = document.createElement('div');
            loader.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.7);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 9999;
            `;
            loader.innerHTML = `
                <div style="text-align: center; color: white;">
                    <div style="width: 50px; height: 50px; border: 4px solid rgba(255, 255, 255, 0.3); border-top-color: #2E7D32; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 16px;"></div>
                    <p style="font-size: 16px; font-weight: 500; margin: 0;">–û—Ç–ø—Ä–∞–≤–∫–∞ –ø–æ–∫–∞–∑–∞–Ω–∏–π...</p>
                </div>
            `;
            document.body.appendChild(loader);
            
            setTimeout(() => {
                loader.remove();
                showSuccess('–ü–æ–∫–∞–∑–∞–Ω–∏—è —É—Å–ø–µ—à–Ω–æ –ø–µ—Ä–µ–¥–∞–Ω—ã!');
                
                // –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ localStorage
                const newReading = {
                    date: new Date().toISOString().split('T')[0],
                    coldWater: readings.coldWater,
                    hotWater: readings.hotWater,
                    gas: readings.gas,
                    electricity: readings.electricity
                };
                
                const history = JSON.parse(localStorage.getItem('meterHistory') || '[]');
                history.unshift(newReading);
                localStorage.setItem('meterHistory', JSON.stringify(history));
                
                // –û–±–Ω–æ–≤–∏—Ç—å –ø—Ä–µ–¥—ã–¥—É—â–∏–µ –ø–æ–∫–∞–∑–∞–Ω–∏—è
                previousReadings.coldWater = readings.coldWater;
                previousReadings.hotWater = readings.hotWater;
                previousReadings.gas = readings.gas;
                previousReadings.electricity = readings.electricity;
                
                // –û—á–∏—Å—Ç–∏—Ç—å —Ñ–æ—Ä–º—É
                document.getElementById('coldWater').value = '';
                document.getElementById('hotWater').value = '';
                document.getElementById('gas').value = '';
                document.getElementById('electricity').value = '';
                
                // –û–±–Ω–æ–≤–∏—Ç—å —Ç–∞–±–ª–∏—Ü—É –∏—Å—Ç–æ—Ä–∏–∏
                renderHistory();
            }, 1500);
        }
        
        function takeMeterPhoto(meterType) {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';
            input.setAttribute('capture', 'environment');
            
            input.onchange = (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        saveMeterPhoto(meterType, event.target.result);
                        showSuccess('–§–æ—Ç–æ —Å—á—ë—Ç—á–∏–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ');
                    };
                    reader.readAsDataURL(file);
                }
            };
            
            input.click();
        }
        
        function saveMeterPhoto(meterType, dataUrl) {
            const photos = JSON.parse(localStorage.getItem('meterPhotos') || '[]');
            photos.push({
                meterType: meterType,
                data: dataUrl,
                date: new Date().toISOString()
            });
            localStorage.setItem('meterPhotos', JSON.stringify(photos));
        }
        
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('ru-RU');
        }
        
        function renderHistory() {
            const tbody = document.querySelector('#meterHistoryTable tbody');
            tbody.innerHTML = '';
            
            const history = JSON.parse(localStorage.getItem('meterHistory') || '[]');
            const allHistory = [...history, ...meterHistory].slice(0, 10);
            
            allHistory.forEach(reading => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${formatDate(reading.date)}</td>
                    <td>${reading.coldWater.toFixed(2)}</td>
                    <td>${reading.hotWater.toFixed(2)}</td>
                    <td>${reading.gas ? reading.gas.toFixed(2) : '-'}</td>
                    <td>${reading.electricity}</td>
                `;
                tbody.appendChild(row);
            });
        }
        
        // –î–æ–±–∞–≤–∏—Ç—å CSS –¥–ª—è –∞–Ω–∏–º–∞—Ü–∏–∏ —Å–ø–∏–Ω–Ω–µ—Ä–∞
        const style = document.createElement('style');
        style.textContent = `
            @keyframes spin {
                to { transform: rotate(360deg); }
            }
        `;
        document.head.appendChild(style);
    </script>
</body>
</html>

