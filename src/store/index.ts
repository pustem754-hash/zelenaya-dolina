п»їРїВ»С—Р С—Р’В»РЎвЂ”/**
 * Р В Р’В Р вЂ™Р’В¦Р В Р’В Р вЂ™Р’ВµР В Р’В Р В РІР‚В¦Р В Р Р‹Р Р†Р вЂљРЎв„ўР В Р Р‹Р В РІР‚С™Р В Р’В Р вЂ™Р’В°Р В Р’В Р вЂ™Р’В»Р В Р’В Р РЋРІР‚ВР В Р’В Р вЂ™Р’В·Р В Р’В Р РЋРІР‚СћР В Р’В Р В РІР‚В Р В Р’В Р вЂ™Р’В°Р В Р’В Р В РІР‚В¦Р В Р’В Р В РІР‚В¦Р В Р Р‹Р Р†Р вЂљРІвЂћвЂ“Р В Р’В Р Р†РІР‚С›РІР‚вЂњ Zustand Store Р В Р’В Р СћРІР‚ВР В Р’В Р вЂ™Р’В»Р В Р Р‹Р В Р РЏ Р В Р’В Р В РІвЂљВ¬Р В Р’В Р РЋРІвЂћСћ Р В РІР‚в„ўР вЂ™Р’В«Р В Р’В Р Р†Р вЂљРІР‚СњР В Р’В Р вЂ™Р’ВµР В Р’В Р вЂ™Р’В»Р В Р Р‹Р Р†Р вЂљР’ВР В Р’В Р В РІР‚В¦Р В Р’В Р вЂ™Р’В°Р В Р Р‹Р В Р РЏ Р В Р’В Р СћРІР‚ВР В Р’В Р РЋРІР‚СћР В Р’В Р вЂ™Р’В»Р В Р’В Р РЋРІР‚ВР В Р’В Р В РІР‚В¦Р В Р’В Р вЂ™Р’В°Р В РІР‚в„ўР вЂ™Р’В»
 * 
 * Р В Р’В Р РЋРІР‚С”Р В Р’В Р вЂ™Р’В±Р В Р Р‹Р В РІР‚В°Р В Р’В Р вЂ™Р’ВµР В Р’В Р СћРІР‚ВР В Р’В Р РЋРІР‚ВР В Р’В Р В РІР‚В¦Р В Р Р‹Р В Р РЏР В Р’В Р вЂ™Р’ВµР В Р Р‹Р Р†Р вЂљРЎв„ў Р В Р’В Р В РІР‚В Р В Р Р‹Р В РЎвЂњР В Р’В Р вЂ™Р’Вµ Р В Р Р‹Р В РЎвЂњР В Р’В Р РЋРІР‚СћР В Р Р‹Р В РЎвЂњР В Р Р‹Р Р†Р вЂљРЎв„ўР В Р’В Р РЋРІР‚СћР В Р Р‹Р В Р РЏР В Р’В Р В РІР‚В¦Р В Р’В Р РЋРІР‚ВР В Р Р‹Р В Р РЏ Р В Р’В Р РЋРІР‚вЂќР В Р Р‹Р В РІР‚С™Р В Р’В Р РЋРІР‚ВР В Р’В Р вЂ™Р’В»Р В Р’В Р РЋРІР‚СћР В Р’В Р вЂ™Р’В¶Р В Р’В Р вЂ™Р’ВµР В Р’В Р В РІР‚В¦Р В Р’В Р РЋРІР‚ВР В Р Р‹Р В Р РЏ:
 * - Р В Р’В Р РЋРІР‚в„ўР В Р Р‹Р РЋРІР‚СљР В Р Р‹Р Р†Р вЂљРЎв„ўР В Р’В Р вЂ™Р’ВµР В Р’В Р В РІР‚В¦Р В Р Р‹Р Р†Р вЂљРЎв„ўР В Р’В Р РЋРІР‚ВР В Р Р‹Р Р†Р вЂљРЎвЂєР В Р’В Р РЋРІР‚ВР В Р’В Р РЋРІР‚СњР В Р’В Р вЂ™Р’В°Р В Р Р‹Р Р†Р вЂљР’В Р В Р’В Р РЋРІР‚ВР В Р Р‹Р В Р РЏ (auth)
 * - Р В Р’В Р Р†Р вЂљРЎСљР В Р’В Р вЂ™Р’В°Р В Р’В Р В РІР‚В¦Р В Р’В Р В РІР‚В¦Р В Р Р‹Р Р†Р вЂљРІвЂћвЂ“Р В Р’В Р вЂ™Р’Вµ Р В Р’В Р РЋРІР‚вЂќР В Р’В Р РЋРІР‚СћР В Р’В Р вЂ™Р’В»Р В Р Р‹Р В Р вЂ°Р В Р’В Р вЂ™Р’В·Р В Р’В Р РЋРІР‚СћР В Р’В Р В РІР‚В Р В Р’В Р вЂ™Р’В°Р В Р Р‹Р Р†Р вЂљРЎв„ўР В Р’В Р вЂ™Р’ВµР В Р’В Р вЂ™Р’В»Р В Р Р‹Р В Р РЏ (user)
 * - Р В Р’В Р РЋРЎСџР В Р’В Р РЋРІР‚СћР В Р’В Р РЋРІР‚СњР В Р’В Р вЂ™Р’В°Р В Р’В Р вЂ™Р’В·Р В Р’В Р вЂ™Р’В°Р В Р’В Р В РІР‚В¦Р В Р’В Р РЋРІР‚ВР В Р Р‹Р В Р РЏ Р В Р Р‹Р В РЎвЂњР В Р Р‹Р Р†Р вЂљР Р‹Р В Р Р‹Р Р†Р вЂљР’ВР В Р Р‹Р Р†Р вЂљРЎв„ўР В Р Р‹Р Р†Р вЂљР Р‹Р В Р’В Р РЋРІР‚ВР В Р’В Р РЋРІР‚СњР В Р’В Р РЋРІР‚СћР В Р’В Р В РІР‚В  (meters)
 * - Р В Р’В Р Р†Р вЂљРІР‚СњР В Р’В Р вЂ™Р’В°Р В Р Р‹Р В Р РЏР В Р’В Р В РІР‚В Р В Р’В Р РЋРІР‚СњР В Р’В Р РЋРІР‚В (requests)
 * - Р В Р’В Р РЋРЎв„ўР В Р’В Р вЂ™Р’ВµР В Р’В Р СћРІР‚ВР В Р’В Р РЋРІР‚ВР В Р’В Р вЂ™Р’В° (photos, videos, audio)
 * - UI Р В Р Р‹Р В РЎвЂњР В Р’В Р РЋРІР‚СћР В Р Р‹Р В РЎвЂњР В Р Р‹Р Р†Р вЂљРЎв„ўР В Р’В Р РЋРІР‚СћР В Р Р‹Р В Р РЏР В Р’В Р В РІР‚В¦Р В Р’В Р РЋРІР‚ВР В Р’В Р вЂ™Р’Вµ
 * 
 * Р В Р’В Р вЂ™Р’ВР В Р’В Р В РІР‚В¦Р В Р Р‹Р Р†Р вЂљРЎв„ўР В Р’В Р вЂ™Р’ВµР В Р’В Р РЋРІР‚вЂњР В Р Р‹Р В РІР‚С™Р В Р’В Р РЋРІР‚ВР В Р Р‹Р В РІР‚С™Р В Р’В Р РЋРІР‚СћР В Р’В Р В РІР‚В Р В Р’В Р вЂ™Р’В°Р В Р’В Р В РІР‚В¦ Р В Р Р‹Р В РЎвЂњР В Р’В Р РЋРІР‚Сћ StorageService Р В Р’В Р СћРІР‚ВР В Р’В Р вЂ™Р’В»Р В Р Р‹Р В Р РЏ Р В Р’В Р РЋРІР‚вЂќР В Р’В Р вЂ™Р’ВµР В Р Р‹Р В РІР‚С™Р В Р Р‹Р В РЎвЂњР В Р’В Р РЋРІР‚ВР В Р Р‹Р В РЎвЂњР В Р Р‹Р Р†Р вЂљРЎв„ўР В Р’В Р вЂ™Р’ВµР В Р’В Р В РІР‚В¦Р В Р Р‹Р Р†Р вЂљРЎв„ўР В Р’В Р В РІР‚В¦Р В Р’В Р РЋРІР‚СћР В Р Р‹Р В РЎвЂњР В Р Р‹Р Р†Р вЂљРЎв„ўР В Р’В Р РЋРІР‚В
 * 
 * @version 1.0.0
 * @project Р В Р’В Р В РІвЂљВ¬Р В Р’В Р РЋРІвЂћСћ Р В РІР‚в„ўР вЂ™Р’В«Р В Р’В Р Р†Р вЂљРІР‚СњР В Р’В Р вЂ™Р’ВµР В Р’В Р вЂ™Р’В»Р В Р Р‹Р Р†Р вЂљР’ВР В Р’В Р В РІР‚В¦Р В Р’В Р вЂ™Р’В°Р В Р Р‹Р В Р РЏ Р В Р’В Р СћРІР‚ВР В Р’В Р РЋРІР‚СћР В Р’В Р вЂ™Р’В»Р В Р’В Р РЋРІР‚ВР В Р’В Р В РІР‚В¦Р В Р’В Р вЂ™Р’В°Р В РІР‚в„ўР вЂ™Р’В» v7.2.4
 */

import { create } from 'zustand';
import { persist, createJSONStorage } from 'zustand/middleware';
import { devtools } from 'zustand/middleware';

// ============================================
// Р В Р’В Р РЋРЎвЂєР В Р’В Р вЂ™Р’ВР В Р’В Р РЋРЎСџР В Р’В Р вЂ™Р’В«
// ============================================

export interface User {
  id: string;
  code: string;
  name: string;
  fullName: string;
  accountNumber: string;
  apartment: string;
  house?: string;
  building?: string;
  phone?: string;
  email?: string;
  area?: number;
  residents?: number;
  storage?: string;
  balance?: number;
}

export interface AuthState {
  isAuthenticated: boolean;
  loginCode: string | null;
  user: User | null;
}

export interface MeterReading {
  id: string;
  type: 'coldWater' | 'hotWater' | 'electricity' | 'gas';
  value: number;
  date: string;
  timestamp: number;
}

export interface Request {
  id: string | number;
  category: string;
  categoryName: string;
  description: string;
  status: 'created' | 'in_progress' | 'completed' | 'rejected';
  statusName: string;
  date: string;
  dateFormatted: string;
  photos?: string[];
  videos?: any[];
  audio?: any[];
  dispatcherPhotos?: string[];
}

export interface MediaItem {
  id: string;
  url: string;
  timestamp: number;
  type?: string;
}

export interface UIState {
  activeSection: string;
  isLoading: boolean;
  error: string | null;
}

// ============================================
// Р В Р’В Р Р†Р вЂљРЎС™Р В Р’В Р Р†Р вЂљРЎвЂќР В Р’В Р РЋРІР‚в„ўР В Р’В Р Р†Р вЂљРІвЂћСћР В Р’В Р РЋРЎС™Р В Р’В Р вЂ™Р’В«Р В Р’В Р Р†РІР‚С›РЎС› STORE
// ============================================

interface AppState {
  // ===== AUTH =====
  auth: AuthState;
  
  // ===== METERS =====
  meters: {
    history: MeterReading[];
    lastReadings: {
      coldWater: number | null;
      hotWater: number | null;
      electricity: number | null;
      gas: number | null;
    };
  };
  
  // ===== REQUESTS =====
  requests: Request[];
  
  // ===== MEDIA =====
  media: {
    photos: MediaItem[];
    videos: MediaItem[];
    audio: MediaItem[];
    requestPhotos: MediaItem[];
    counterPhotos: MediaItem[];
    meterPhotos: MediaItem[];
  };
  
  // ===== UI =====
  ui: UIState;
  
  // ===== ACTIONS =====
  
  // Auth actions
  login: (code: string, user: User) => void;
  logout: () => void;
  updateUser: (user: Partial<User>) => void;
  
  // Meters actions
  addMeterReading: (reading: Omit<MeterReading, 'id' | 'timestamp'>) => void;
  updateLastReading: (type: MeterReading['type'], value: number) => void;
  
  // Requests actions
  addRequest: (request: Request) => void;
  updateRequest: (id: string | number, updates: Partial<Request>) => void;
  deleteRequest: (id: string | number) => void;
  
  // Media actions
  addPhoto: (photo: MediaItem, category?: 'request' | 'counter' | 'meter') => void;
  deletePhoto: (id: string, category?: 'request' | 'counter' | 'meter') => void;
  addVideo: (video: MediaItem) => void;
  deleteVideo: (id: string) => void;
  addAudio: (audio: MediaItem) => void;
  deleteAudio: (id: string) => void;
  
  // UI actions
  setActiveSection: (section: string) => void;
  setLoading: (isLoading: boolean) => void;
  setError: (error: string | null) => void;
  
  // Utility
  clearAll: () => void;
  syncWithStorage: () => void;
}

// ============================================
// Р В Р’В Р РЋРЎС™Р В Р’В Р РЋРІР‚в„ўР В Р’В Р вЂ™Р’В§Р В Р’В Р РЋРІР‚в„ўР В Р’В Р Р†Р вЂљРЎвЂќР В Р’В Р вЂ™Р’В¬Р В Р’В Р РЋРЎС™Р В Р’В Р вЂ™Р’В«Р В Р’В Р Р†Р вЂљРЎС› Р В Р’В Р В Р вЂ№Р В Р’В Р РЋРІР‚С”Р В Р’В Р В Р вЂ№Р В Р’В Р РЋРЎвЂєР В Р’В Р РЋРІР‚С”Р В Р’В Р В РІР‚РЋР В Р’В Р РЋРЎС™Р В Р’В Р вЂ™Р’ВР В Р’В Р В РІР‚РЋ
// ============================================

const initialState = {
  auth: {
    isAuthenticated: false,
    loginCode: null,
    user: null,
  },
  meters: {
    history: [],
    lastReadings: {
      coldWater: null,
      hotWater: null,
      electricity: null,
      gas: null,
    },
  },
  requests: [],
  media: {
    photos: [],
    videos: [],
    audio: [],
    requestPhotos: [],
    counterPhotos: [],
    meterPhotos: [],
  },
  ui: {
    activeSection: 'home',
    isLoading: false,
    error: null,
  },
};

// ============================================
// CUSTOM STORAGE (Р В Р’В Р РЋРІР‚ВР В Р’В Р В РІР‚В¦Р В Р Р‹Р Р†Р вЂљРЎв„ўР В Р’В Р вЂ™Р’ВµР В Р’В Р РЋРІР‚вЂњР В Р Р‹Р В РІР‚С™Р В Р’В Р вЂ™Р’В°Р В Р Р‹Р Р†Р вЂљР’В Р В Р’В Р РЋРІР‚ВР В Р Р‹Р В Р РЏ Р В Р Р‹Р В РЎвЂњР В Р’В Р РЋРІР‚Сћ StorageService)
// ============================================

const storageServiceAdapter = {
  getItem: (name: string): string | null => {
    // Р В Р’В Р вЂ™Р’ВР В Р Р‹Р В РЎвЂњР В Р’В Р РЋРІР‚вЂќР В Р’В Р РЋРІР‚СћР В Р’В Р вЂ™Р’В»Р В Р Р‹Р В Р вЂ°Р В Р’В Р вЂ™Р’В·Р В Р Р‹Р РЋРІР‚СљР В Р’В Р вЂ™Р’ВµР В Р’В Р РЋР’В Р В Р’В Р РЋРІР‚вЂњР В Р’В Р вЂ™Р’В»Р В Р’В Р РЋРІР‚СћР В Р’В Р вЂ™Р’В±Р В Р’В Р вЂ™Р’В°Р В Р’В Р вЂ™Р’В»Р В Р Р‹Р В Р вЂ°Р В Р’В Р В РІР‚В¦Р В Р Р‹Р Р†Р вЂљРІвЂћвЂ“Р В Р’В Р Р†РІР‚С›РІР‚вЂњ storage Р В Р’В Р РЋРІР‚ВР В Р’В Р вЂ™Р’В· StorageService
    if (typeof window !== 'undefined' && (window as any).storage) {
      const data = (window as any).storage.get(name.replace('zd_', ''), null);
      return data ? JSON.stringify(data) : null;
    }
    return null;
  },
  setItem: (name: string, value: string): void => {
    if (typeof window !== 'undefined' && (window as any).storage) {
      try {
        const data = JSON.parse(value);
        (window as any).storage.set(name.replace('zd_', ''), data);
      } catch (e) {
        console.error('Error saving to StorageService:', e);
      }
    }
  },
  removeItem: (name: string): void => {
    if (typeof window !== 'undefined' && (window as any).storage) {
      (window as any).storage.remove(name.replace('zd_', ''));
    }
  },
};

// ============================================
// STORE CREATION
// ============================================

export const useAppStore = create<AppState>()(
  devtools(
    persist(
      (set, get) => ({
        ...initialState,
        
        // ===== AUTH ACTIONS =====
        
        login: (code, user) => {
          console.log('Р РЋР вЂљР РЋРЎСџР Р†Р вЂљРЎСљР РЋРІР‚в„ў Zustand: login', { code, user });
          set({ 
            auth: { 
              isAuthenticated: true, 
              loginCode: code, 
              user 
            } 
          });
        },
        
        logout: () => {
          console.log('Р РЋР вЂљР РЋРЎСџР РЋРІвЂћСћР В РІР‚С› Zustand: logout');
          set({ auth: initialState.auth });
          // Р В Р’В Р РЋРІР‚С”Р В Р Р‹Р Р†Р вЂљР Р‹Р В Р’В Р РЋРІР‚ВР В Р Р‹Р В РЎвЂњР В Р Р‹Р Р†Р вЂљРЎв„ўР В Р’В Р РЋРІР‚СњР В Р’В Р вЂ™Р’В° Р В Р’В Р СћРІР‚ВР В Р Р‹Р В РІР‚С™Р В Р Р‹Р РЋРІР‚СљР В Р’В Р РЋРІР‚вЂњР В Р’В Р РЋРІР‚ВР В Р Р‹Р Р†Р вЂљР’В¦ Р В Р’В Р СћРІР‚ВР В Р’В Р вЂ™Р’В°Р В Р’В Р В РІР‚В¦Р В Р’В Р В РІР‚В¦Р В Р Р‹Р Р†Р вЂљРІвЂћвЂ“Р В Р Р‹Р Р†Р вЂљР’В¦ Р В Р’В Р РЋРІР‚вЂќР В Р Р‹Р В РІР‚С™Р В Р’В Р РЋРІР‚В Р В Р’В Р В РІР‚В Р В Р Р‹Р Р†Р вЂљРІвЂћвЂ“Р В Р Р‹Р Р†Р вЂљР’В¦Р В Р’В Р РЋРІР‚СћР В Р’В Р СћРІР‚ВР В Р’В Р вЂ™Р’Вµ
          set({ 
            meters: initialState.meters,
            requests: initialState.requests,
            media: initialState.media,
          });
        },
        
        updateUser: (updates) => {
          const currentUser = get().auth.user;
          if (!currentUser) return;
          
          console.log('Р РЋР вЂљР РЋРЎСџР Р†Р вЂљР’ВР вЂ™Р’В¤ Zustand: updateUser', updates);
          set({
            auth: {
              ...get().auth,
              user: { ...currentUser, ...updates },
            },
          });
        },
        
        // ===== METERS ACTIONS =====
        
        addMeterReading: (reading) => {
          const id = `meter_${Date.now()}`;
          const timestamp = Date.now();
          
          const fullReading: MeterReading = {
            ...reading,
            id,
            timestamp,
          };
          
          console.log('Р РЋР вЂљР РЋРЎСџР Р†Р вЂљРЎС™Р В РІР‚В° Zustand: addMeterReading', fullReading);
          
          set((state) => ({
            meters: {
              ...state.meters,
              history: [fullReading, ...state.meters.history.slice(0, 49)], // Max 50
            },
          }));
          
          // Р В Р’В Р РЋРЎвЂєР В Р’В Р вЂ™Р’В°Р В Р’В Р РЋРІР‚СњР В Р’В Р вЂ™Р’В¶Р В Р’В Р вЂ™Р’Вµ Р В Р’В Р РЋРІР‚СћР В Р’В Р вЂ™Р’В±Р В Р’В Р В РІР‚В¦Р В Р’В Р РЋРІР‚СћР В Р’В Р В РІР‚В Р В Р’В Р вЂ™Р’В»Р В Р Р‹Р В Р РЏР В Р’В Р вЂ™Р’ВµР В Р’В Р РЋР’В lastReadings
          get().updateLastReading(reading.type, reading.value);
        },
        
        updateLastReading: (type, value) => {
          console.log('Р РЋР вЂљР РЋРЎСџР Р†Р вЂљРЎС™Р Р†РІР‚С™Р’В¬ Zustand: updateLastReading', { type, value });
          set((state) => ({
            meters: {
              ...state.meters,
              lastReadings: {
                ...state.meters.lastReadings,
                [type]: value,
              },
            },
          }));
        },
        
        // ===== REQUESTS ACTIONS =====
        
        addRequest: (request) => {
          console.log('Р РЋР вЂљР РЋРЎСџР Р†Р вЂљРЎС™Р РЋРЎС™ Zustand: addRequest', request);
          set((state) => ({
            requests: [request, ...state.requests],
          }));
        },
        
        updateRequest: (id, updates) => {
          console.log('Р В Р вЂ Р РЋРЎв„ўР В Р РЏР В РЎвЂ”Р РЋРІР‚ВР В Р РЏ Zustand: updateRequest', { id, updates });
          set((state) => ({
            requests: state.requests.map((req) =>
              req.id === id ? { ...req, ...updates } : req
            ),
          }));
        },
        
        deleteRequest: (id) => {
          console.log('Р РЋР вЂљР РЋРЎСџР Р†Р вЂљРІР‚СњР Р†Р вЂљР’ВР В РЎвЂ”Р РЋРІР‚ВР В Р РЏ Zustand: deleteRequest', id);
          set((state) => ({
            requests: state.requests.filter((req) => req.id !== id),
          }));
        },
        
        // ===== MEDIA ACTIONS =====
        
        addPhoto: (photo, category = 'request') => {
          console.log('Р РЋР вЂљР РЋРЎСџР Р†Р вЂљРЎС™Р вЂ™Р’В· Zustand: addPhoto', { photo, category });
          
          const categoryMap = {
            request: 'requestPhotos',
            counter: 'counterPhotos',
            meter: 'meterPhotos',
          };
          
          const key = categoryMap[category] || 'photos';
          
          set((state) => ({
            media: {
              ...state.media,
              [key]: [photo, ...state.media[key as keyof typeof state.media]],
            },
          }));
        },
        
        deletePhoto: (id, category = 'request') => {
          console.log('Р РЋР вЂљР РЋРЎСџР Р†Р вЂљРІР‚СњР Р†Р вЂљР’ВР В РЎвЂ”Р РЋРІР‚ВР В Р РЏ Zustand: deletePhoto', { id, category });
          
          const categoryMap = {
            request: 'requestPhotos',
            counter: 'counterPhotos',
            meter: 'meterPhotos',
          };
          
          const key = categoryMap[category] || 'photos';
          
          set((state) => ({
            media: {
              ...state.media,
              [key]: state.media[key as keyof typeof state.media].filter(
                (p: any) => p.id !== id
              ),
            },
          }));
        },
        
        addVideo: (video) => {
          console.log('Р РЋР вЂљР РЋРЎСџР В РІР‚в„–Р СћРЎвЂ™ Zustand: addVideo', video);
          set((state) => ({
            media: {
              ...state.media,
              videos: [video, ...state.media.videos],
            },
          }));
        },
        
        deleteVideo: (id) => {
          console.log('Р РЋР вЂљР РЋРЎСџР Р†Р вЂљРІР‚СњР Р†Р вЂљР’ВР В РЎвЂ”Р РЋРІР‚ВР В Р РЏ Zustand: deleteVideo', id);
          set((state) => ({
            media: {
              ...state.media,
              videos: state.media.videos.filter((v) => v.id !== id),
            },
          }));
        },
        
        addAudio: (audio) => {
          console.log('Р РЋР вЂљР РЋРЎСџР В РІР‚в„–Р вЂ™Р’Вµ Zustand: addAudio', audio);
          set((state) => ({
            media: {
              ...state.media,
              audio: [audio, ...state.media.audio],
            },
          }));
        },
        
        deleteAudio: (id) => {
          console.log('Р РЋР вЂљР РЋРЎСџР Р†Р вЂљРІР‚СњР Р†Р вЂљР’ВР В РЎвЂ”Р РЋРІР‚ВР В Р РЏ Zustand: deleteAudio', id);
          set((state) => ({
            media: {
              ...state.media,
              audio: state.media.audio.filter((a) => a.id !== id),
            },
          }));
        },
        
        // ===== UI ACTIONS =====
        
        setActiveSection: (section) => {
          console.log('Р РЋР вЂљР РЋРЎСџР В РІР‚в„–Р В РІР‚РЋ Zustand: setActiveSection', section);
          set((state) => ({
            ui: { ...state.ui, activeSection: section },
          }));
        },
        
        setLoading: (isLoading) => {
          set((state) => ({
            ui: { ...state.ui, isLoading },
          }));
        },
        
        setError: (error) => {
          console.error('Р В Р вЂ Р РЋРЎС™Р В Р вЂ° Zustand: setError', error);
          set((state) => ({
            ui: { ...state.ui, error },
          }));
        },
        
        // ===== UTILITY =====
        
        clearAll: () => {
          console.log('Р РЋР вЂљР РЋРЎСџР вЂ™Р’В§Р Р†РІР‚С›РІР‚вЂњ Zustand: clearAll');
          set(initialState);
        },
        
        syncWithStorage: () => {
          console.log('Р РЋР вЂљР РЋРЎСџР Р†Р вЂљРЎСљР Р†Р вЂљРЎвЂє Zustand: syncWithStorage - loading from StorageService');
          
          if (typeof window === 'undefined' || !(window as any).storage) {
            console.warn('Р В Р вЂ Р РЋРІвЂћСћР вЂ™Р’В Р В РЎвЂ”Р РЋРІР‚ВР В Р РЏ StorageService not available');
            return;
          }
          
          const storage = (window as any).storage;
          
          // Р В Р’В Р Р†Р вЂљРІР‚СњР В Р’В Р вЂ™Р’В°Р В Р’В Р РЋРІР‚вЂњР В Р Р‹Р В РІР‚С™Р В Р Р‹Р РЋРІР‚СљР В Р’В Р вЂ™Р’В·Р В Р’В Р РЋРІР‚ВР В Р Р‹Р Р†Р вЂљРЎв„ўР В Р Р‹Р В Р вЂ° auth
          const loginCode = storage.get('login_code', null);
          const userData = storage.get('userData', null);
          
          if (loginCode && userData) {
            set({
              auth: {
                isAuthenticated: true,
                loginCode,
                user: userData,
              },
            });
          }
          
          // Р В Р’В Р Р†Р вЂљРІР‚СњР В Р’В Р вЂ™Р’В°Р В Р’В Р РЋРІР‚вЂњР В Р Р‹Р В РІР‚С™Р В Р Р‹Р РЋРІР‚СљР В Р’В Р вЂ™Р’В·Р В Р’В Р РЋРІР‚ВР В Р Р‹Р Р†Р вЂљРЎв„ўР В Р Р‹Р В Р вЂ° meters
          const metersHistory = storage.get('metersHistory', []);
          const lastColdWater = storage.get('lastColdWater', null);
          const lastHotWater = storage.get('lastHotWater', null);
          const lastElectricity = storage.get('lastElectricity', null);
          const lastGas = storage.get('lastGas', null);
          
          set({
            meters: {
              history: metersHistory,
              lastReadings: {
                coldWater: lastColdWater,
                hotWater: lastHotWater,
                electricity: lastElectricity,
                gas: lastGas,
              },
            },
          });
          
          // Р В Р’В Р Р†Р вЂљРІР‚СњР В Р’В Р вЂ™Р’В°Р В Р’В Р РЋРІР‚вЂњР В Р Р‹Р В РІР‚С™Р В Р Р‹Р РЋРІР‚СљР В Р’В Р вЂ™Р’В·Р В Р’В Р РЋРІР‚ВР В Р Р‹Р Р†Р вЂљРЎв„ўР В Р Р‹Р В Р вЂ° requests
          const requests = storage.get('requests', []);
          set({ requests });
          
          // Р В Р’В Р Р†Р вЂљРІР‚СњР В Р’В Р вЂ™Р’В°Р В Р’В Р РЋРІР‚вЂњР В Р Р‹Р В РІР‚С™Р В Р Р‹Р РЋРІР‚СљР В Р’В Р вЂ™Р’В·Р В Р’В Р РЋРІР‚ВР В Р Р‹Р Р†Р вЂљРЎв„ўР В Р Р‹Р В Р вЂ° media
          const photos = storage.get('photos', []);
          const videos = storage.get('videos', []);
          const audio = storage.get('audio', []);
          const requestPhotos = storage.get('requestPhotos', []);
          const counterPhotos = storage.get('counterPhotos', []);
          const meterPhotos = storage.get('meterPhotos', []);
          
          set({
            media: {
              photos,
              videos,
              audio,
              requestPhotos,
              counterPhotos,
              meterPhotos,
            },
          });
          
          console.log('Р В Р вЂ Р РЋРЎв„ўР Р†Р вЂљР’В¦ Zustand: syncWithStorage complete');
        },
      }),
      {
        name: 'app-storage', // Р В Р’В Р РЋРІвЂћСћР В Р’В Р вЂ™Р’В»Р В Р Р‹Р В РІР‚в„–Р В Р Р‹Р Р†Р вЂљР Р‹ Р В Р’В Р СћРІР‚ВР В Р’В Р вЂ™Р’В»Р В Р Р‹Р В Р РЏ persist
        storage: createJSONStorage(() => storageServiceAdapter),
        partialize: (state) => ({
          // Р В Р’В Р В Р вЂ№Р В Р’В Р РЋРІР‚СћР В Р Р‹Р Р†Р вЂљР’В¦Р В Р Р‹Р В РІР‚С™Р В Р’В Р вЂ™Р’В°Р В Р’В Р В РІР‚В¦Р В Р Р‹Р В Р РЏР В Р’В Р вЂ™Р’ВµР В Р’В Р РЋР’В Р В Р Р‹Р Р†Р вЂљРЎв„ўР В Р’В Р РЋРІР‚СћР В Р’В Р вЂ™Р’В»Р В Р Р‹Р В Р вЂ°Р В Р’В Р РЋРІР‚СњР В Р’В Р РЋРІР‚Сћ Р В Р’В Р В РІР‚В Р В Р’В Р вЂ™Р’В°Р В Р’В Р вЂ™Р’В¶Р В Р’В Р В РІР‚В¦Р В Р Р‹Р Р†Р вЂљРІвЂћвЂ“Р В Р’В Р вЂ™Р’Вµ Р В Р’В Р СћРІР‚ВР В Р’В Р вЂ™Р’В°Р В Р’В Р В РІР‚В¦Р В Р’В Р В РІР‚В¦Р В Р Р‹Р Р†Р вЂљРІвЂћвЂ“Р В Р’В Р вЂ™Р’Вµ
          auth: state.auth,
          meters: {
            history: state.meters.history.slice(0, 50), // Р В Р’В Р РЋРІР‚С”Р В Р’В Р РЋРІР‚вЂњР В Р Р‹Р В РІР‚С™Р В Р’В Р вЂ™Р’В°Р В Р’В Р В РІР‚В¦Р В Р’В Р РЋРІР‚ВР В Р Р‹Р Р†Р вЂљР Р‹Р В Р’В Р РЋРІР‚ВР В Р’В Р В РІР‚В Р В Р’В Р вЂ™Р’В°Р В Р’В Р вЂ™Р’ВµР В Р’В Р РЋР’В
            lastReadings: state.meters.lastReadings,
          },
          requests: state.requests.slice(0, 50),
          // UI Р В Р’В Р В РІР‚В¦Р В Р’В Р вЂ™Р’Вµ Р В Р Р‹Р В РЎвЂњР В Р’В Р РЋРІР‚СћР В Р Р‹Р Р†Р вЂљР’В¦Р В Р Р‹Р В РІР‚С™Р В Р’В Р вЂ™Р’В°Р В Р’В Р В РІР‚В¦Р В Р Р‹Р В Р РЏР В Р’В Р вЂ™Р’ВµР В Р’В Р РЋР’В - Р В Р’В Р РЋРІР‚СћР В Р’В Р В РІР‚В¦ Р В Р Р‹Р В Р Р‰Р В Р Р‹Р Р†Р вЂљРЎвЂєР В Р’В Р вЂ™Р’ВµР В Р’В Р РЋР’ВР В Р’В Р вЂ™Р’ВµР В Р Р‹Р В РІР‚С™Р В Р’В Р В РІР‚В¦Р В Р Р‹Р Р†Р вЂљРІвЂћвЂ“Р В Р’В Р Р†РІР‚С›РІР‚вЂњ
        }),
      }
    ),
    {
      name: 'App Store', // Р В Р’В Р вЂ™Р’ВР В Р’В Р РЋР’ВР В Р Р‹Р В Р РЏ Р В Р’В Р СћРІР‚ВР В Р’В Р вЂ™Р’В»Р В Р Р‹Р В Р РЏ DevTools
      enabled: process.env.NODE_ENV === 'development',
    }
  )
);

// ============================================
// Р В Р’В Р В Р вЂ№Р В Р’В Р Р†Р вЂљРЎС›Р В Р’В Р Р†Р вЂљРЎвЂќР В Р’В Р Р†Р вЂљРЎС›Р В Р’В Р РЋРІвЂћСћР В Р’В Р РЋРЎвЂєР В Р’В Р РЋРІР‚С”Р В Р’В Р вЂ™Р’В Р В Р’В Р вЂ™Р’В« (Р В Р’В Р СћРІР‚ВР В Р’В Р вЂ™Р’В»Р В Р Р‹Р В Р РЏ Р В Р’В Р РЋРІР‚СћР В Р’В Р РЋРІР‚вЂќР В Р Р‹Р Р†Р вЂљРЎв„ўР В Р’В Р РЋРІР‚ВР В Р’В Р РЋР’ВР В Р’В Р РЋРІР‚ВР В Р’В Р вЂ™Р’В·Р В Р’В Р вЂ™Р’В°Р В Р Р‹Р Р†Р вЂљР’В Р В Р’В Р РЋРІР‚ВР В Р’В Р РЋРІР‚В re-renders)
// ============================================

export const selectAuth = (state: AppState) => state.auth;
export const selectUser = (state: AppState) => state.auth.user;
export const selectIsAuthenticated = (state: AppState) => state.auth.isAuthenticated;

export const selectMeters = (state: AppState) => state.meters;
export const selectMetersHistory = (state: AppState) => state.meters.history;
export const selectLastReadings = (state: AppState) => state.meters.lastReadings;

export const selectRequests = (state: AppState) => state.requests;
export const selectActiveRequests = (state: AppState) =>
  state.requests.filter((r) => r.status !== 'completed' && r.status !== 'rejected');

export const selectMedia = (state: AppState) => state.media;
export const selectPhotos = (state: AppState) => state.media.photos;
export const selectVideos = (state: AppState) => state.media.videos;

export const selectUI = (state: AppState) => state.ui;
export const selectIsLoading = (state: AppState) => state.ui.isLoading;
export const selectError = (state: AppState) => state.ui.error;

// ============================================
// Р В Р’В Р СћРЎвЂ™Р В Р’В Р В РІвЂљВ¬Р В Р’В Р РЋРІвЂћСћР В Р’В Р вЂ™Р’В (Р В Р Р‹Р РЋРІР‚СљР В Р’В Р СћРІР‚ВР В Р’В Р РЋРІР‚СћР В Р’В Р вЂ™Р’В±Р В Р’В Р В РІР‚В¦Р В Р Р‹Р Р†Р вЂљРІвЂћвЂ“Р В Р’В Р вЂ™Р’Вµ Р В Р’В Р РЋРІР‚СћР В Р’В Р вЂ™Р’В±Р В Р Р‹Р Р†Р вЂљР’ВР В Р Р‹Р В РІР‚С™Р В Р Р‹Р Р†Р вЂљРЎв„ўР В Р’В Р РЋРІР‚СњР В Р’В Р РЋРІР‚В)
// ============================================

export const useAuth = () => useAppStore(selectAuth);
export const useUser = () => useAppStore(selectUser);
export const useIsAuthenticated = () => useAppStore(selectIsAuthenticated);

export const useMeters = () => useAppStore(selectMeters);
export const useRequests = () => useAppStore(selectRequests);
export const useMedia = () => useAppStore(selectMedia);

export const useUI = () => useAppStore(selectUI);

console.log('Р РЋР вЂљР РЋРЎСџР В Р РЏР В РІР‚С› Zustand Store initialized');









